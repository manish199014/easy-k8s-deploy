name: Deploy EKS Cluster (OIDC)

on:
  workflow_dispatch:
    # Inputs for keys are removed as they are no longer needed.

# Permission required to request the OIDC token from GitHub
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Replaces manual credential setting. 
      # This action exchanges the GitHub OIDC token for temporary AWS credentials.
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # The ARN of the IAM Role you created in AWS to trust this repo
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
          aws-region: us-east-1
          role-session-name: GitHubActionsEKSDeploy

      - name: Deploy EKS Cluster
        # The configure-aws-credentials action automatically sets the 
        # AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_SESSION_TOKEN
        # environment variables for this step.
        run: |
          cd aws
          chmod +x start.sh
          ./start.sh
