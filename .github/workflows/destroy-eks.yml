name: Destroy EKS Cluster (OIDC)

on:
  workflow_dispatch:
    # Inputs for Access/Secret Keys are removed as we now use OIDC.

# These permissions are required for the OIDC token exchange
permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Configure AWS Credentials using OIDC
      # This replaces the manual environment variable setup for keys
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # The ARN of the IAM Role you created in AWS to trust this repo
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
          aws-region: us-east-1
          role-session-name: GitHubActionsEKSDestroy

      - name: Destroy EKS Cluster
        # The environment variables AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, 
        # and AWS_SESSION_TOKEN are automatically set by the previous step.
        run: |
          cd aws
          chmod +x destroy.sh
          ./destroy.sh
